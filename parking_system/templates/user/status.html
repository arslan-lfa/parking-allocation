{% extends "base.html" %}
{% block title %}Check Request Status | SmartPark{% endblock %}
{% block page_title %}Request Status Tracker{% endblock %}

{% block content %}
<div class="grid grid-2">
    <div class="card">
        <div class="card-header">
            <div>
                <h2 class="card-title">Find Your Request</h2>
                <p class="card-subtitle">Enter your request ID to check status</p>
            </div>
        </div>
        <div class="card-content">
            <form id="status-form">
                <div class="form-group">
                    <label for="request_id">
                        <i class="fas fa-key"></i> Request ID
                    </label>
                    <input type="text" id="request_id" name="request_id" placeholder="e.g., 550e8400-e29b-41d4-a716-446655440000" required>
                    <small style="color: var(--text-light);">Copy the ID from your confirmation message</small>
                </div>

                <button type="submit" class="btn btn-primary btn-lg" style="width: 100%; justify-content: center;">
                    <i class="fas fa-search"></i>
                    Search
                </button>
            </form>

            <div id="status-msg" style="margin-top: 1.5rem;"></div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <div>
                <h2 class="card-title">Status Guide</h2>
                <p class="card-subtitle">Understand request statuses</p>
            </div>
        </div>
        <div class="card-content">
            <div style="display: grid; gap: 1rem;">
                <div style="display: flex; align-items: flex-start; gap: 1rem;">
                    <span class="badge-status badge-allocated">New</span>
                    <span style="color: var(--text-light);">Request created and pending validation</span>
                </div>
                <div style="display: flex; align-items: flex-start; gap: 1rem;">
                    <span class="badge-status badge-allocated">Validated</span>
                    <span style="color: var(--text-light);">Request verified and ready for allocation</span>
                </div>
                <div style="display: flex; align-items: flex-start; gap: 1rem;">
                    <span class="badge-status badge-active">Allocated</span>
                    <span style="color: var(--text-light);">Parking slot assigned to vehicle</span>
                </div>
                <div style="display: flex; align-items: flex-start; gap: 1rem;">
                    <span class="badge-status badge-active">Active</span>
                    <span style="color: var(--text-light);">Vehicle is currently parked</span>
                </div>
                <div style="display: flex; align-items: flex-start; gap: 1rem;">
                    <span class="badge-status badge-completed">Completed</span>
                    <span style="color: var(--text-light);">Parking session ended</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div id="detailed-status" style="display: none;"></div>

{% endblock %}

{% block extra_js %}
<script>
document.getElementById("status-form").addEventListener("submit", async (e) => {
    e.preventDefault();
    showLoadingSpinner(true);
    
    const request_id = document.getElementById("request_id").value;

    try {
        const resp = await fetch(`/api/user/status/${request_id}`);
        const data = await resp.json();
        
        if (data.status === "success") {
            const requestData = data.data;
            displayRequestStatus(requestData);
            showNotification('Request found!', 'success');
        } else {
            showNotification(data.message || 'Request not found', 'error');
            const container = document.getElementById("detailed-status");
            container.innerHTML = `
                <div class="alert alert-error" style="margin-top: 2rem;">
                    <i class="fas fa-exclamation-circle"></i>
                    <div>
                        <strong>Not Found</strong>
                        <p style="margin: 0.5rem 0 0 0;">${data.message || 'The request ID could not be found in the system.'}</p>
                    </div>
                </div>
            `;
            container.style.display = 'block';
        }
    } catch (err) {
        showNotification('Error fetching status', 'error');
        const container = document.getElementById("detailed-status");
        container.innerHTML = `
            <div class="alert alert-error" style="margin-top: 2rem;">
                <i class="fas fa-exclamation-circle"></i>
                <div>
                    <strong>Error</strong>
                    <p style="margin: 0.5rem 0 0 0;">${err.message}</p>
                </div>
            </div>
        `;
        container.style.display = 'block';
    } finally {
        showLoadingSpinner(false);
    }
});

async function releaseParking(requestId) {
    if (!confirm('Are you sure you want to release this parking slot?')) return;
    
    showLoadingSpinner(true);
    try {
        const resp = await fetch('/api/user/release_request', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ request_id: requestId })
        });
        const data = await resp.json();
        
        if (data.status === 'success') {
            showNotification('Parking slot released successfully!', 'success');
            document.getElementById("request_id").value = '';
            const container = document.getElementById("detailed-status");
            container.innerHTML = '';
            container.style.display = 'none';
        } else {
            showNotification(data.message || 'Error releasing parking', 'error');
        }
    } catch (err) {
        showNotification('Error releasing parking', 'error');
    } finally {
        showLoadingSpinner(false);
    }
}
</script>
{% endblock %}
