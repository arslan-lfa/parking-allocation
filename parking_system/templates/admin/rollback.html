{% extends "base.html" %}
{% block title %}Rollback Operations | SmartPark{% endblock %}
{% block page_title %}Rollback Manager{% endblock %}

{% block content %}
<div class="alert alert-warning" style="margin-bottom: 2rem;">
    <i class="fas fa-exclamation-triangle"></i>
    <div>
        <strong>Caution: Rollback Operations</strong>
        <p style="margin: 0.5rem 0 0 0;">Rolling back operations will reverse recent parking allocations and may affect user sessions. Use with care.</p>
    </div>
</div>

<div class="grid grid-2">
    <div class="card">
        <div class="card-header">
            <div>
                <h2 class="card-title">Rollback Operations</h2>
                <p class="card-subtitle">Revert recent system changes</p>
            </div>
        </div>
        <div class="card-content">
            <form id="rollback-form">
                <div class="form-group">
                    <label for="rollback-count">
                        <i class="fas fa-undo"></i> Number of Operations
                    </label>
                    <input type="number" id="rollback-count" name="k" min="1" max="100" value="5" required>
                    <small style="color: var(--text-light);">Select how many recent operations to undo</small>
                </div>

                <div style="margin-top: 1.5rem; padding: 1rem; background: var(--light); border-radius: 8px; border-left: 4px solid var(--danger);">
                    <small style="color: var(--text-light);">
                        <i class="fas fa-info-circle" style="margin-right: 0.5rem;"></i>
                        <strong>Impact:</strong> This will affect <span id="impact-count">5</span> allocation(s)
                    </small>
                </div>

                <button type="submit" class="btn btn-danger btn-lg" style="width: 100%; margin-top: 2rem; justify-content: center;">
                    <i class="fas fa-undo-alt"></i>
                    Execute Rollback
                </button>
            </form>
            <div id="rollback-msg" style="margin-top: 1.5rem;"></div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <div>
                <h2 class="card-title">Recent Operations</h2>
                <p class="card-subtitle">Last 10 system operations</p>
            </div>
        </div>
        <div class="card-content">
            <div id="operations-list" style="display: grid; gap: 1rem; max-height: 500px; overflow-y: auto;">
                <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p>Loading operations...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card" style="margin-top: 2rem;">
    <div class="card-header">
        <div>
            <h2 class="card-title">Rollback History</h2>
            <p class="card-subtitle">Previous rollback operations performed</p>
        </div>
    </div>
    <div class="card-content">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Date & Time</th>
                    <th>Operations Rolled Back</th>
                    <th>Affected Requests</th>
                    <th>Admin</th>
                    <th>Status</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>2024-01-15 14:30:22</td>
                    <td>3</td>
                    <td>REQ-001, REQ-002, REQ-003</td>
                    <td>admin@smartpark.com</td>
                    <td><span class="badge-status badge-completed">Success</span></td>
                </tr>
                <tr>
                    <td>2024-01-14 10:15:45</td>
                    <td>1</td>
                    <td>REQ-025</td>
                    <td>admin@smartpark.com</td>
                    <td><span class="badge-status badge-completed">Success</span></td>
                </tr>
                <tr>
                    <td>2024-01-13 16:48:12</td>
                    <td>5</td>
                    <td>REQ-041 through REQ-045</td>
                    <td>admin@smartpark.com</td>
                    <td><span class="badge-status badge-completed">Success</span></td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div class="card" style="margin-top: 2rem;">
    <div class="card-header">
        <div>
            <h2 class="card-title">System Recommendations</h2>
            <p class="card-subtitle">Guidance on rollback operations</p>
        </div>
    </div>
    <div class="card-content">
        <div style="display: grid; gap: 1rem;">
            <div style="padding: 1rem; background: var(--light); border-radius: 8px; border-left: 4px solid var(--info);">
                <strong><i class="fas fa-lightbulb" style="color: var(--info); margin-right: 0.5rem;"></i>Optimal Timing</strong>
                <p style="margin: 0.5rem 0 0 0; color: var(--text-light);">Perform rollbacks during low-traffic periods to minimize disruption</p>
            </div>

            <div style="padding: 1rem; background: var(--light); border-radius: 8px; border-left: 4px solid var(--warning);">
                <strong><i class="fas fa-comment" style="color: var(--warning); margin-right: 0.5rem;"></i>Communication</strong>
                <p style="margin: 0.5rem 0 0 0; color: var(--text-light);">Notify users if their allocations will be affected by the rollback</p>
            </div>

            <div style="padding: 1rem; background: var(--light); border-radius: 8px; border-left: 4px solid var(--success);">
                <strong><i class="fas fa-check" style="color: var(--success); margin-right: 0.5rem;"></i>Verification</strong>
                <p style="margin: 0.5rem 0 0 0; color: var(--text-light);">Always verify system state after performing a rollback</p>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
const rollbackForm = document.getElementById('rollback-form');
const rollbackCountInput = document.getElementById('rollback-count');
const impactCount = document.getElementById('impact-count');

// Update impact count as user changes input
rollbackCountInput.addEventListener('change', () => {
    impactCount.textContent = rollbackCountInput.value;
});

// Load recent operations
async function loadRecentOperations() {
    try {
        const resp = await fetch('/api/admin/recent_operations');
        const data = await resp.json();
        
        if (data.status === 'success') {
            renderOperations(data.data || []);
        }
    } catch (err) {
        console.error('Error loading operations:', err);
        showNotification('Error loading operations', 'error');
    }
}

function renderOperations(operations) {
    const container = document.getElementById('operations-list');
    container.innerHTML = '';
    
    if (operations.length === 0) {
        container.innerHTML = '<p style="color: var(--text-light); text-align: center;">No operations available</p>';
        return;
    }
    
    operations.forEach((op, index) => {
        const opDiv = document.createElement('div');
        opDiv.style.padding = '0.75rem';
        opDiv.style.background = 'var(--light)';
        opDiv.style.borderRadius = '6px';
        opDiv.style.borderLeft = '3px solid var(--primary)';
        opDiv.style.fontSize = '0.875rem';
        
        const timestamp = new Date(op.timestamp).toLocaleTimeString();
        
        opDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between;">
                <strong>#${index + 1}</strong>
                <span style="color: var(--text-light);">${timestamp}</span>
            </div>
            <p style="margin: 0.5rem 0 0 0; color: var(--text-light);">
                ${op.type} - ${op.description || 'Operation'}
            </p>
        `;
        
        container.appendChild(opDiv);
    });
}

// Handle rollback submission
rollbackForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const k = parseInt(rollbackCountInput.value);
    
    if (!confirm(`Are you sure you want to rollback the last ${k} operation(s)? This action cannot be undone.`)) {
        return;
    }
    
    showLoadingSpinner(true);
    
    try {
        const resp = await fetch('/api/admin/rollback', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ k })
        });
        
        const data = await resp.json();
        
        if (data.status === 'success') {
            showNotification(`Successfully rolled back ${k} operation(s)`, 'success');
            document.getElementById('rollback-msg').innerHTML = `
                <div class="alert alert-success" style="margin-top: 1rem;">
                    <i class="fas fa-check-circle"></i>
                    <div>
                        <strong>Rollback Completed</strong>
                        <p style="margin: 0.5rem 0 0 0;">${data.message}</p>
                    </div>
                </div>
            `;
            
            // Reload operations list
            setTimeout(() => {
                loadRecentOperations();
            }, 1000);
        } else {
            showNotification(data.message || 'Rollback failed', 'error');
            document.getElementById('rollback-msg').innerHTML = `
                <div class="alert alert-error" style="margin-top: 1rem;">
                    <i class="fas fa-exclamation-circle"></i>
                    <div>
                        <strong>Rollback Failed</strong>
                        <p style="margin: 0.5rem 0 0 0;">${data.message}</p>
                    </div>
                </div>
            `;
        }
    } catch (err) {
        showNotification('Error executing rollback', 'error');
        document.getElementById('rollback-msg').innerHTML = `
            <div class="alert alert-error" style="margin-top: 1rem;">
                <i class="fas fa-exclamation-circle"></i>
                <div>
                    <strong>Error</strong>
                    <p style="margin: 0.5rem 0 0 0;">${err.message}</p>
                </div>
            </div>
        `;
    } finally {
        showLoadingSpinner(false);
    }
}

// Load operations on page load
document.addEventListener('DOMContentLoaded', loadRecentOperations);

// Auto-refresh operations every 30 seconds
setInterval(loadRecentOperations, 30000);
</script>

<style>
.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table thead tr {
    border-bottom: 2px solid var(--border);
}

.data-table th {
    padding: 0.75rem;
    text-align: left;
    font-weight: 600;
    color: var(--text-light);
}

.data-table td {
    padding: 1rem 0.75rem;
    border-bottom: 1px solid var(--border);
}

.data-table tbody tr:hover {
    background: var(--light);
}
</style>
{% endblock %}
