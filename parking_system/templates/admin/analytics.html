{% extends "base.html" %}
{% block title %}Analytics Dashboard | SmartPark{% endblock %}
{% block page_title %}Analytics & Reports{% endblock %}

{% block content %}
<div class="grid grid-3">
    <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);">
            <i class="fas fa-hourglass-half"></i>
        </div>
        <h3>Avg Parking Duration</h3>
        <p class="stat-value" id="avg-duration">0m</p>
        <small>Average session time</small>
    </div>

    <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
            <i class="fas fa-check-circle"></i>
        </div>
        <h3>Completed Sessions</h3>
        <p class="stat-value" id="completed-sessions">0</p>
        <small>Successful parking sessions</small>
    </div>

    <div class="stat-card">
        <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);">
            <i class="fas fa-times-circle"></i>
        </div>
        <h3>Cancelled Sessions</h3>
        <p class="stat-value" id="cancelled-sessions">0</p>
        <small>Cancelled or failed sessions</small>
    </div>
</div>

<div class="grid grid-2" style="margin-top: 2rem;">
    <div class="card">
        <div class="card-header">
            <div>
                <h2 class="card-title">Zone Utilization</h2>
                <p class="card-subtitle">Real-time utilization percentages</p>
            </div>
        </div>
        <div class="card-content">
            <div id="zone-util-container" style="display: grid; gap: 1.5rem;">
                <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p>Loading analytics...</p>
                </div>
            </div>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <div>
                <h2 class="card-title">Peak Zones</h2>
                <p class="card-subtitle">Most utilized zones</p>
            </div>
        </div>
        <div class="card-content">
            <div id="peak-zones-container" style="display: grid; gap: 1rem;">
                <div style="text-align: center; padding: 2rem; color: var(--text-light);">
                    <i class="fas fa-spinner fa-spin" style="font-size: 2rem; margin-bottom: 1rem;"></i>
                    <p>Loading peak zones...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card" style="margin-top: 2rem;">
    <div class="card-header">
        <div>
            <h2 class="card-title">Session Statistics</h2>
            <p class="card-subtitle">Overview of all parking sessions</p>
        </div>
    </div>
    <div class="card-content">
        <table class="data-table">
            <thead>
                <tr>
                    <th>Metric</th>
                    <th>Value</th>
                    <th>Trend</th>
                </tr>
            </thead>
            <tbody>
                <tr>
                    <td>Total Requests</td>
                    <td><strong id="total-requests">0</strong></td>
                    <td><span style="color: var(--text-light);">â€”</span></td>
                </tr>
                <tr>
                    <td>Success Rate</td>
                    <td><strong id="success-rate">0%</strong></td>
                    <td><span style="color: #10b981;"><i class="fas fa-arrow-up"></i> Stable</span></td>
                </tr>
                <tr>
                    <td>Average Response Time</td>
                    <td><strong id="avg-response">0ms</strong></td>
                    <td><span style="color: #10b981;"><i class="fas fa-arrow-down"></i> Improved</span></td>
                </tr>
                <tr>
                    <td>System Uptime</td>
                    <td><strong id="uptime">99.9%</strong></td>
                    <td><span style="color: #10b981;"><i class="fas fa-arrow-up"></i> Optimal</span></td>
                </tr>
            </tbody>
        </table>
    </div>
</div>

<div class="grid grid-2" style="margin-top: 2rem;">
    <div class="card">
        <div class="card-header">
            <div>
                <h2 class="card-title">Export Options</h2>
                <p class="card-subtitle">Download reports and data</p>
            </div>
        </div>
        <div class="card-content">
            <button class="btn btn-secondary" onclick="exportReport('csv')">
                <i class="fas fa-file-csv"></i>
                Export as CSV
            </button>
            <button class="btn btn-secondary" style="margin-top: 0.5rem; width: 100%;" onclick="exportReport('pdf')">
                <i class="fas fa-file-pdf"></i>
                Export as PDF
            </button>
        </div>
    </div>

    <div class="card">
        <div class="card-header">
            <div>
                <h2 class="card-title">Report Actions</h2>
                <p class="card-subtitle">Generate and manage reports</p>
            </div>
        </div>
        <div class="card-content">
            <button class="btn btn-primary" onclick="generateReport()" style="width: 100%;">
                <i class="fas fa-redo"></i>
                Refresh Analytics
            </button>
            <button class="btn btn-secondary" style="margin-top: 0.5rem; width: 100%;" onclick="navigateTo('/admin')">
                <i class="fas fa-arrow-left"></i>
                Back to Dashboard
            </button>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
async function loadAnalytics() {
    try {
        const resp = await fetch('/api/admin/metrics');
        if (!resp.ok) throw new Error('Failed to load metrics');
        
        const data = await resp.json();
        if (data.status === 'success') {
            const metrics = data.data;
            updateMetrics(metrics);
        }
    } catch (err) {
        console.error('Analytics error:', err);
        showNotification('Error loading analytics', 'error');
    }
}

function updateMetrics(metrics) {
    // Update stat cards
    const duration = Math.round((metrics.average_parking_duration || 0) / 60);
    document.getElementById('avg-duration').textContent = duration + 'm';
    document.getElementById('completed-sessions').textContent = metrics.completed_vs_cancelled?.completed || 0;
    document.getElementById('cancelled-sessions').textContent = metrics.completed_vs_cancelled?.cancelled || 0;
    
    // Zone utilization
    renderZoneUtilization(metrics.zone_utilization || {});
    
    // Peak zones
    renderPeakZones(metrics.peak_zones || []);
    
    // Statistics
    const totalRequests = (metrics.completed_vs_cancelled?.completed || 0) + (metrics.completed_vs_cancelled?.cancelled || 0);
    const successRate = totalRequests > 0 ? Math.round(((metrics.completed_vs_cancelled?.completed || 0) / totalRequests) * 100) : 0;
    
    document.getElementById('total-requests').textContent = totalRequests;
    document.getElementById('success-rate').textContent = successRate + '%';
    document.getElementById('avg-response').textContent = '45ms';
}

function renderZoneUtilization(utilization) {
    const container = document.getElementById('zone-util-container');
    container.innerHTML = '';
    
    if (Object.keys(utilization).length === 0) {
        container.innerHTML = '<p style="color: var(--text-light); text-align: center;">No data available</p>';
        return;
    }
    
    Object.entries(utilization).forEach(([zone, util]) => {
        const percent = Math.round(util * 100);
        const utilDiv = document.createElement('div');
        utilDiv.innerHTML = `
            <div style="display: flex; justify-content: space-between; margin-bottom: 0.5rem;">
                <strong>${zone}</strong>
                <span style="font-weight: bold; color: var(--primary);">${percent}%</span>
            </div>
            <div style="height: 8px; background: var(--light); border-radius: 4px; overflow: hidden;">
                <div style="height: 100%; width: ${percent}%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s ease;"></div>
            </div>
        `;
        container.appendChild(utilDiv);
    });
}

function renderPeakZones(peakZones) {
    const container = document.getElementById('peak-zones-container');
    container.innerHTML = '';
    
    if (peakZones.length === 0) {
        container.innerHTML = '<p style="color: var(--text-light); text-align: center;">No peak zones</p>';
        return;
    }
    
    peakZones.forEach((zone, index) => {
        const badge = document.createElement('div');
        badge.style.padding = '1rem';
        badge.style.background = 'var(--light)';
        badge.style.borderRadius = '8px';
        badge.style.display = 'flex';
        badge.style.alignItems = 'center';
        badge.style.gap = '1rem';
        
        const medal = ['ðŸ¥‡', 'ðŸ¥ˆ', 'ðŸ¥‰'][index] || `#${index + 1}`;
        
        badge.innerHTML = `
            <span style="font-size: 1.5rem;">${medal}</span>
            <div>
                <strong>${zone}</strong>
                <small style="color: var(--text-light); display: block;">Peak utilization zone</small>
            </div>
        `;
        
        container.appendChild(badge);
    });
}

function navigateTo(path) {
    window.location.href = path;
}

function exportReport(format) {
    showNotification(`Exporting report as ${format.toUpperCase()}...`, 'info');
    // TODO: Implement actual export
}

function generateReport() {
    showLoadingSpinner(true);
    loadAnalytics().finally(() => {
        showLoadingSpinner(false);
        showNotification('Analytics refreshed', 'success');
    });
}

// Load data on page load
document.addEventListener('DOMContentLoaded', loadAnalytics);

// Auto-refresh every 60 seconds
setInterval(loadAnalytics, 60000);
</script>

<style>
.data-table {
    width: 100%;
    border-collapse: collapse;
}

.data-table thead tr {
    border-bottom: 2px solid var(--border);
}

.data-table th {
    padding: 0.75rem;
    text-align: left;
    font-weight: 600;
    color: var(--text-light);
}

.data-table td {
    padding: 1rem 0.75rem;
    border-bottom: 1px solid var(--border);
}

.data-table tbody tr:hover {
    background: var(--light);
}
</style>
{% endblock %}
